{% extends "base.html" %} {% block title %}Planification Future{% endblock %} {%
block content %}
<div class="fade-in">
  <div class="row mb-5 text-center">
    <div class="col-lg-8 mx-auto">
      <div class="badge bg-info text-dark mb-2">Beta</div>
      <h1 class="text-white fw-bold display-5">Planification Future</h1>
      <p class="text-white-50 lead">
        Anticipez les coûts de gestion des déchets pour une date spécifique
        grâce à notre module de séries temporelles.
      </p>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-md-5">
      <div class="card shadow-lg border-0">
        <div class="card-body p-5">
          <form id="futureForm">
            <div class="row">
              <!-- Pays -->
              <div class="col-md-6 mb-3">
                <label
                  class="form-label fw-bold text-uppercase small text-muted"
                  >Pays</label
                >
                <select
                  class="form-select"
                  id="selectPays"
                  name="pays"
                  required
                >
                  <option value="">Sélectionner un pays</option>
                  {% for p in pays %}
                  <option value="{{ p }}">{{ p }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Région -->
              <div class="col-md-6 mb-3">
                <label
                  class="form-label fw-bold text-uppercase small text-muted"
                  >Région</label
                >
                <select
                  class="form-select"
                  id="selectRegion"
                  name="region"
                  disabled
                  required
                >
                  <option value="">D'abord choisir un pays</option>
                  {% for r in regions %}
                  <option value="{{ r }}">{{ r }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold text-uppercase small text-muted"
                >Hôpital Cible</label
              >
              <select
                class="form-select form-select-lg"
                id="selectHopital"
                name="hopital"
                disabled
                required
              >
                <option value="">Choisir la région...</option>
                {% for h in hopitaux %}
                <option value="{{ h }}">{{ h }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold text-uppercase small text-muted"
                >Date de prévision</label
              >
              <input
                type="date"
                class="form-control form-select-lg"
                name="date_future"
                required
                min="2024-01-01"
              />
              <div class="form-text">
                Sélectionnez une date dans le futur pour voir les estimations.
              </div>
            </div>

            <button
              type="submit"
              class="btn btn-info w-100 btn-lg text-white fw-bold"
            >
              <i class="fas fa-search-dollar me-2"></i> Estimer le Coût
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-5 d-flex flex-column">
      <!-- État initial -->
      <div
        id="initialState"
        class="flex-grow-1 d-flex align-items-center justify-content-center border rounded-3 p-5"
        style="
          border: 2px dashed rgba(255, 255, 255, 0.2) !important;
          min-height: 400px;
        "
      >
        <div class="text-center text-white-50">
          <i class="fas fa-calendar-alt fa-4x mb-3 opacity-50"></i>
          <h4>En attente...</h4>
          <p>Remplissez le formulaire ci-contre pour générer une estimation.</p>
        </div>
      </div>

      <!-- Résultat (Caché par défaut) -->
      <div
        id="resultCard"
        class="card bg-dark text-white border-secondary flex-grow-1 shadow-lg w-100"
        style="display: none"
      >
        <div class="card-header border-secondary bg-transparent py-3">
          <h5 class="mb-0">
            <i class="fas fa-chart-line text-info me-2"></i> Estimation pour le
            <span id="resDate"></span>
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center mt-3">
            <!-- Coût -->
            <div class="col-6 mb-4 border-end border-secondary">
              <small class="text-white-50 text-uppercase ls-1"
                >Coût Estimé</small
              >
              <h2 class="fw-bold text-info my-2" id="resCout">0 $</h2>
              <small class="text-muted d-block" style="font-size: 0.7rem">
                Min: <span id="resMin">0</span> - Max:
                <span id="resMax">0</span>
              </small>
            </div>

            <!-- Quantité -->
            <div class="col-6 mb-4">
              <small class="text-white-50 text-uppercase ls-1"
                >Quantité Probable</small
              >
              <h2 class="fw-bold text-warning my-2">
                <span id="resQty">0</span> kg
              </h2>
            </div>

            <!-- Type -->
            <div class="col-6 mb-3 border-end border-secondary">
              <small class="text-white-50 text-uppercase ls-1"
                >Type Dominant</small
              >
              <div class="mt-2">
                <span class="badge bg-primary px-3 py-2" id="resType"
                  >Inconnu</span
                >
              </div>
            </div>

            <!-- Risque -->
            <div class="col-6 mb-3">
              <small class="text-white-50 text-uppercase ls-1"
                >Risque Sanitaire</small
              >
              <div class="mt-2">
                <span class="badge bg-danger px-3 py-2" id="resRisk"
                  >Moyen</span
                >
              </div>
            </div>
          </div>
        </div>
        <div
          class="card-footer bg-transparent border-secondary text-center py-3"
        >
          <small class="text-muted"
            ><i class="fas fa-info-circle me-1"></i> Basé sur l'historique de
            l'établissement</small
          >
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // 1. Cascading Logic
  document
    .getElementById("selectPays")
    .addEventListener("change", async function () {
      const pays = this.value;
      const regionSelect = document.getElementById("selectRegion");
      const hopitalSelect = document.getElementById("selectHopital");

      // Reset inputs
      regionSelect.innerHTML = '<option value="">Chargement...</option>';
      hopitalSelect.innerHTML =
        '<option value="">D\'abord choisir une région</option>';
      hopitalSelect.disabled = true;

      if (!pays) {
        regionSelect.innerHTML =
          '<option value="">D\'abord choisir un pays</option>';
        regionSelect.disabled = true;
        return;
      }

      // Fetch Regions
      const res = await fetch(`/api/regions_by_pays?pays=${pays}`);
      const data = await res.json();

      regionSelect.innerHTML =
        '<option value="">Sélectionner une région</option>';
      data.regions.forEach((r) => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        regionSelect.appendChild(opt);
      });
      regionSelect.disabled = false;
    });

  document
    .getElementById("selectRegion")
    .addEventListener("change", async function () {
      const region = this.value;
      const pays = document.getElementById("selectPays").value;
      const hopitalSelect = document.getElementById("selectHopital");

      hopitalSelect.innerHTML = '<option value="">Chargement...</option>';

      if (!region) {
        hopitalSelect.innerHTML =
          '<option value="">D\'abord choisir une région</option>';
        hopitalSelect.disabled = true;
        return;
      }

      // Fetch Hopitaux
      const res = await fetch(
        `/api/hopitaux_by_region?region=${region}&pays=${pays}`
      );
      const data = await res.json();

      hopitalSelect.innerHTML =
        '<option value="">Sélectionner un hôpital</option>';
      data.hopitaux.forEach((h) => {
        const opt = document.createElement("option");
        opt.value = h;
        opt.textContent = h;
        hopitalSelect.appendChild(opt);
      });
      hopitalSelect.disabled = false;
    });

  // 2. Form Submission
  document
    .getElementById("futureForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const btn = this.querySelector("button");
      const originalText = btn.innerHTML;
      btn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Analyse en cours...';
      btn.disabled = true;

      try {
        const formData = new FormData(this);
        const response = await fetch("/planification-future", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.error) throw new Error(data.error);

        // Update UI
        document.getElementById("initialState").style.display = "none";
        document.getElementById("resultCard").style.display = "block";

        // Date
        document.getElementById("resDate").textContent = data.date_analysee;

        // Cost
        document.getElementById("resCout").textContent =
          data.cout_estime.toLocaleString("fr-FR") + " $";
        document.getElementById("resMin").textContent =
          data.cout_min.toLocaleString("fr-FR") + " $";
        document.getElementById("resMax").textContent =
          data.cout_max.toLocaleString("fr-FR") + " $";

        // Quantity
        document.getElementById("resQty").textContent =
          data.qty_estime.toLocaleString("fr-FR");

        // Type
        document.getElementById("resType").textContent = data.type_probable;

        // Risque
        const rLabel = document.getElementById("resRisk");
        rLabel.textContent = data.risque_estime;

        // Color coding risk
        rLabel.className = "badge px-3 py-2 ";
        if (data.risque_estime === "Élevé" || data.risque_estime === "High")
          rLabel.classList.add("bg-danger");
        else if (
          data.risque_estime === "Moyen" ||
          data.risque_estime === "Medium"
        )
          rLabel.classList.add("bg-warning", "text-dark");
        else rLabel.classList.add("bg-success");
      } catch (e) {
        alert("Erreur: " + e.message);
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    });
</script>
{% endblock %}
